#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>

uint32_t encrypt_rsa_montgomery(uint32_t P, uint32_t e, uint32_t N) {
    uint32_t invN = get_invN(N);
    uint32_t R2 = get_R_squared(N);
    uint32_t P_bar = REDC((uint64_t)P * R2, N, invN);
    uint32_t res_bar = REDC((uint64_t)1 * R2, N, invN);

    while (e > 0) {
        if (e % 2 == 1) {
            res_bar = REDC((uint64_t)res_bar * P_bar, N, invN);
        }
        P_bar = REDC((uint64_t)P_bar * P_bar, N, invN);
        e /= 2;
    }
    return REDC((uint64_t)res_bar, N, invN);
}

uint32_t decrypt_rsa_montgomery(uint32_t C, uint32_t d, uint32_t N) {
    uint32_t invN = get_invN(N);
    uint32_t R2 = get_R_squared(N);
    uint32_t C_bar = REDC((uint64_t)C * R2, N, invN);
    uint32_t res_bar = REDC((uint64_t)1 * R2, N, invN);
    while (d > 0) {
        if (d % 2 == 1) {
            res_bar = REDC((uint64_t)res_bar * C_bar, N, invN);
        }
        // C = C * C mod N (in Montgomery Space)
        C_bar = REDC((uint64_t)C_bar * C_bar, N, invN);
        d /= 2;
    }
    return REDC((uint64_t)res_bar, N, invN);
}
